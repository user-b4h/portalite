<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>マイポータル（PC候補＋モバイルオーバーレイ＋ダークモード改善）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, sans-serif; background:#f3f4f6; color:#1f2937; }
    .card { background:#fff; }
    @media (prefers-color-scheme: dark) {
      body { background:#1f2937; color:#e5e7eb; }
      .card { background:#374151; }
    }
    /* 検索オーバーレイ */
    #search-overlay {
      position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: #fff;
      z-index: 9999;
      display: none;
      flex-direction: column;
    }
    @media (prefers-color-scheme: dark) {
      #search-overlay { background: #1f2937; }
    }
  </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
  <div class="w-full max-w-4xl space-y-8">
    <header class="text-center">
      <h1 class="text-4xl sm:text-5xl font-bold mb-2">マイポータル</h1>
      <p class="text-lg">検索、天気、最新ニュース</p>
    </header>

    <!-- 検索セクション -->
    <section class="card p-6 rounded-2xl shadow-lg relative">
      <h2 class="text-2xl font-semibold mb-4">ウェブ検索</h2>
      <div class="input-group flex space-x-2">
        <input id="search-input-main" type="text" placeholder="検索キーワードを入力..."
               class="flex-grow min-w-0 p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500
                      dark:bg-gray-800 dark:border-gray-500 dark:text-gray-100 dark:placeholder-gray-400"
               autocomplete="off">
        <button id="search-button-main"
                class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
          検索
        </button>
      </div>
      <!-- PC用検索候補コンテナ -->
      <div id="suggestions-container-main"
           class="absolute z-10 w-full mt-2 bg-white dark:bg-gray-700 rounded-xl shadow-lg border border-gray-200 dark:border-gray-600 hidden">
      </div>
    </section>

    <!-- 天気セクション -->
    <section class="card p-6 rounded-2xl shadow-lg">
      <h2 class="text-2xl font-semibold mb-4">札幌の天気</h2>
      <div id="weather-container" class="grid sm:grid-cols-3 gap-4 text-center">
        <div class="text-center col-span-3">天気情報を取得中...</div>
      </div>
    </section>

    <!-- ニュースセクション -->
    <section class="card p-6 rounded-2xl shadow-lg">
      <h2 class="text-2xl font-semibold mb-4">最新ニュース (NHK)</h2>
      <div id="news-container" class="space-y-4">
        <div class="text-center">ニュースを取得中...</div>
      </div>
    </section>
  </div>

  <!-- 検索オーバーレイ -->
  <div id="search-overlay" class="hidden">
    <div class="p-4 flex items-center space-x-2 border-b border-gray-200 dark:border-gray-600">
      <input id="search-input-overlay" type="text"
             class="flex-grow min-w-0 p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500
                    dark:bg-gray-800 dark:border-gray-500 dark:text-gray-100 dark:placeholder-gray-400"
             placeholder="検索キーワード..." autocomplete="off">
      <button id="overlay-search-button"
              class="flex-shrink-0 bg-blue-600 text-white px-3 py-2 rounded-xl hover:bg-blue-700 transition duration-300 text-sm">
        検索
      </button>
      <button id="cancel-button"
              class="flex-shrink-0 text-blue-500 font-semibold text-sm ml-1">
        キャンセル
      </button>
    </div>
    <div id="suggestions-container-overlay" class="flex-grow overflow-y-auto p-2"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const weatherContainer = document.getElementById('weather-container');
      const newsContainer = document.getElementById('news-container');

      const mainInput = document.getElementById('search-input-main');
      const mainButton = document.getElementById('search-button-main');
      const mainSuggestions = document.getElementById('suggestions-container-main');

      const overlay = document.getElementById('search-overlay');
      const overlayInput = document.getElementById('search-input-overlay');
      const overlaySearchButton = document.getElementById('overlay-search-button');
      const cancelButton = document.getElementById('cancel-button');
      const overlaySuggestions = document.getElementById('suggestions-container-overlay');

      const weatherApiUrl = 'https://weather.tsukumijima.net/api/forecast?city=016010';
      const newsRssUrl = 'https://www.nhk.or.jp/rss/news/cat0.xml';

      const localSuggestions = ['今日の天気', '最新ニュース', 'Google', 'YouTube', 'Gmail', 'Google Maps', '今日のランチ', 'おすすめの映画', '最新技術', 'プログラミング'];

      async function fetchWeather() {
        try {
          weatherContainer.innerHTML = '<div class="text-center col-span-3">天気情報を取得中...</div>';
          const r = await fetch(weatherApiUrl);
          const data = await r.json();
          weatherContainer.innerHTML = '';
          data.forecasts.slice(0, 3).forEach(forecast => {
            const el = document.createElement('div');
            el.className = 'p-4 rounded-xl shadow-inner card';
            el.innerHTML = `
              <p class="text-lg font-bold">${forecast.dateLabel}</p>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${forecast.telop}</p>
              <div class="flex justify-center items-center space-x-2 text-sm">
                <span class="text-blue-500">最低: ${forecast.temperature.min?.celsius || '--'}°C</span>
                <span class="text-red-500">最高: ${forecast.temperature.max?.celsius || '--'}°C</span>
              </div>
            `;
            weatherContainer.appendChild(el);
          });
        } catch {}
      }

      async function fetchNews() {
        try {
          newsContainer.innerHTML = '<div class="text-center">ニュースを取得中...</div>';
          const r = await fetch(newsRssUrl);
          const txt = await r.text();
          const xml = new DOMParser().parseFromString(txt, 'text/xml');
          const items = xml.querySelectorAll('item');
          newsContainer.innerHTML = '';
          items.forEach(item => {
            const title = item.querySelector('title')?.textContent;
            const link = item.querySelector('link')?.textContent;
            if (title && link) {
              const a = document.createElement('a');
              a.href = link;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.className = 'block p-3 rounded-xl shadow-sm hover:bg-gray-100 dark:hover:bg-gray-600 transition duration-300';
              a.textContent = title;
              newsContainer.appendChild(a);
            }
          });
        } catch {}
      }

      function jsonp(url, params = {}, timeout = 5000) {
        return new Promise((resolve, reject) => {
          const callbackName = 'jsonp_cb_' + Date.now();
          params.callback = callbackName;
          const query = Object.keys(params).map(k => `${encodeURIComponent(k)}=${encodeURIComponent(params[k])}`).join('&');
          const fullUrl = url + (url.includes('?') ? '&' : '?') + query;
          const script = document.createElement('script');
          script.src = fullUrl;
          let timer = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, timeout);
          function cleanup() {
            clearTimeout(timer);
            try { delete window[callbackName]; } catch { window[callbackName] = undefined; }
            if (script.parentNode) script.parentNode.removeChild(script);
          }
          window[callbackName] = (data) => { cleanup(); resolve(data); };
          script.onerror = () => { cleanup(); reject(new Error('JSONP script error')); };
          document.body.appendChild(script);
        });
      }

      async function fetchGoogleSuggestionsJSONP(query) {
        if (!query) return [];
        const url = 'https://suggestqueries.google.com/complete/search';
        try {
          const data = await jsonp(url, { client: 'firefox', hl: 'ja', q: query }, 4000);
          if (Array.isArray(data) && Array.isArray(data[1])) {
            return data[1].map(item => typeof item === 'string' ? item : (Array.isArray(item) ? item[0] : String(item)));
          }
          return [];
        } catch { return []; }
      }

      function renderSuggestions(list, container) {
        container.innerHTML = '';
        if (!list || list.length === 0) { container.classList.add('hidden'); return; }
        container.classList.remove('hidden');
        list.forEach(s => {
          const item = document.createElement('div');
          item.textContent = s;
          item.className = 'p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-150 rounded-lg';
          item.addEventListener('click', () => {
            if (container === overlaySuggestions) overlayInput.value = s;
            else mainInput.value = s;
            doSearch(s);
          });
          container.appendChild(item);
        });
      }

      function doSearch(q) {
        if (!q) return;
        window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank');
        closeOverlay();
        mainSuggestions.classList.add('hidden');
      }

      function debounce(fn, wait=200) {
        let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
      }

      const onInput = debounce(async (evt, container) => {
        const q = evt.target.value.trim();
        if (!q) { container.innerHTML = ''; container.classList.add('hidden'); return; }
        const suggestions = await fetchGoogleSuggestionsJSONP(q);
        renderSuggestions(
          suggestions.length > 0 ? suggestions : localSuggestions.filter(x => x.toLowerCase().includes(q.toLowerCase())),
          container
        );
      }, 180);

      // PC入力
      mainInput.addEventListener('input', (e) => onInput(e, mainSuggestions));
      mainButton.addEventListener('click', () => doSearch(mainInput.value.trim()));

      // スマホでオーバーレイ起動
      mainInput.addEventListener('focus', () => {
        if (window.innerWidth <= 768) {
          overlay.style.display = 'flex';
          overlay.classList.remove('hidden');
          overlayInput.value = '';
          overlaySuggestions.innerHTML = '';
          setTimeout(() => overlayInput.focus(), 100);
        }
      });

      // オーバーレイ入力
      overlayInput.addEventListener('input', (e) => onInput(e, overlaySuggestions));
      overlayInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') doSearch(overlayInput.value.trim()); });
      overlaySearchButton.addEventListener('click', () => doSearch(overlayInput.value.trim()));
      cancelButton.addEventListener('click', closeOverlay);

      function closeOverlay() { overlay.style.display = 'none'; }

      fetchWeather();
      fetchNews();
    });
  </script>
</body>
</html>
